name: File Overflow and Error Prevention
permissions:
  contents: read
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  file-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pathlib humanize
          
      - name: Check file sizes and prevent overflow
        run: |
          python << 'EOF'
          import os
          import sys
          from pathlib import Path
          import humanize
          
          # Configuration
          MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB in bytes
          MAX_TOTAL_SIZE = 500 * 1024 * 1024  # 500MB in bytes
          
          # Files and directories to ignore
          IGNORE_PATTERNS = {
              '.git',
              '__pycache__',
              'node_modules',
              '.pytest_cache',
              'venv',
              'env',
              '.venv',
              'dist',
              'build',
              '*.pyc',
              '*.pyo',
              '*.pyd',
              '.DS_Store'
          }
          
          def should_ignore(path):
              """Check if path should be ignored"""
              path_str = str(path)
              for pattern in IGNORE_PATTERNS:
                  if pattern in path_str:
                      return True
              return False
          
          def check_file_sizes(root_path):
              """Check all file sizes in the repository"""
              total_size = 0
              large_files = []
              
              for file_path in Path(root_path).rglob('*'):
                  if file_path.is_file() and not should_ignore(file_path):
                      size = file_path.stat().st_size
                      total_size += size
                      
                      if size > MAX_FILE_SIZE:
                          large_files.append({
                              'path': str(file_path.relative_to(root_path)),
                              'size': size,
                              'readable': humanize.naturalsize(size)
                          })
              
              return total_size, large_files
          
          # Run the checks
          print("üîç Checking file sizes...")
          print(f"Maximum allowed file size: {humanize.naturalsize(MAX_FILE_SIZE)}")
          print(f"Maximum allowed total size: {humanize.naturalsize(MAX_TOTAL_SIZE)}")
          print()
          
          total_size, large_files = check_file_sizes('.')
          
          print(f"üìä Total repository size: {humanize.naturalsize(total_size)}")
          print()
          
          # Check for large files
          if large_files:
              print("‚ùå ERROR: Found files exceeding size limit:")
              for file_info in large_files:
                  print(f"  - {file_info['path']}: {file_info['readable']}")
              sys.exit(1)
          
          # Check total size
          if total_size > MAX_TOTAL_SIZE:
              print(f"‚ùå ERROR: Total repository size ({humanize.naturalsize(total_size)}) exceeds limit")
              sys.exit(1)
          
          print("‚úÖ All file size checks passed!")
          EOF
          
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: file-validation-report
          path: |
            **/*.log
            **/validation-*.txt
          retention-days: 7
